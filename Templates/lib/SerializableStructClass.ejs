// MARK: SerializableStructClass.ejs
<% serializable.isModel = !!serializable.based["Model"]; %>
extension <%- serializable.name %> : SerializableToDocument {
	<%# Classes need their designated initializers to be in the definition of the body, so we use automatic inline code generation. %>
	<% if (serializable.kind == "class") { %>// sourcery:inline:auto:<%- serializable.name %>.Meow<% } %>
	<%_ -%>
	@available(*, unavailable, message: "This API is internal to Meow. You can create a new instance using your own inits or using init(newFrom:).")
	<%- acl %> <% if (serializable.kind == "class") { %>required <% }%>init(restoring source: BSON.Primitive) throws {
		guard let document = source as? BSON.Document else {
			throw Meow.Error.cannotDeserialize(type: <%- serializable.name %>.self, source: source, expectedPrimitive: BSON.Document.self);
		}

		<% if (serializable.based["Model"]) { %>Meow.pool.free(self._id)
		self._id = try document.unpack("_id")<% }

		serializable.variables.forEach(variable => {
			if (variable.isComputed || variable.isStatic) { return; }

			ensureSerializable(variable.type || variable.typeName);
			%>
		self.<%- variable.name %> = try<%- variable.isOptional ? '?' : '' %> document.unpack(Key.<%- variable.name %>.keyString)<%
		});
		%>
	}

	<%- acl %> <% if (serializable.kind == "class") { %>required <% }%>init(newFrom source: BSON.Primitive) throws {
		guard let document = source as? BSON.Document else {
			throw Meow.Error.cannotDeserialize(type: <%- serializable.name %>.self, source: source, expectedPrimitive: BSON.Document.self);
		}

		<%
		serializable.variables.sort((a, b) => (a.defaultValue && !b.defaultValue ? 1 : -1)).forEach(variable => {
			if (variable.isComputed || variable.isStatic) { return; }

			ensureSerializable(variable.type || variable.typeName);
			%>
		self.<%- variable.name %> = (try<%- variable.isOptional || variable.defaultValue ? '?' : '' %> document.unpack(Key.<%- variable.name %>.keyString)) <%- variable.defaultValue ? '?? self.' + variable.name : '' %><%
		});
		%>
	}

	<% if (serializable.kind == "class") { %>
	<% if (serializable.based["Model"]) { %>
	<%- acl %> var _id = Meow.pool.newObjectId() { didSet { Meow.pool.free(oldValue) } }

	deinit {
		Meow.pool.handleDeinit(self)
	}
	<% } %>
		// sourcery:end
	<% } %>

	<%- acl %> func serialize() -> Document {
		var document: Document = [:]
		<% if (serializable.based["Model"]) { %>document.pack(self._id, as: "_id")<% }

		serializable.variables.forEach(variable => {
			if (variable.isComputed || variable.isStatic) { return; }

			if (variable.type) {
				ensureSerializable(variable.type);
			}
			%>
		document.pack(self.<%- variable.name %>, as: Key.<%- variable.name %>.keyString)<%
		});
		%>
		return document
	}

	<%- acl %> static func validateUpdate(with document: Document) throws {
		let keys = document.keys
		<%_ serializable.variables.forEach(variable => {
			if (variable.isComputed || variable.isStatic) { return; } -%>
		if keys.contains(Key.<%- variable.name %>.keyString) {
			_ = (try<%- variable.isOptional ? '?' : '' %> document.unpack(Key.<%- variable.name %>.keyString)) as <%- variable.typeName.name %>
		}
		<%_ }) -%>
	}

	<%- acl %> <% if (serializable.kind == "struct") { %>mutating <% } %>func update(with document: Document) throws {
		try <%- serializable.name %>.validateUpdate(with: document)

		for key in document.keys {
			switch key {
			<%_ serializable.variables.forEach(variable => {
				if (variable.isComputed || variable.isStatic) { return; }
				-%>
			case Key.<%- variable.name %>.keyString:
				self.<%- variable.name %> = try document.unpack(Key.<%- variable.name %>.keyString)
			<%_ }) -%>
			default: break
			}
		}
	}

	<% if (serializable.based["Model"]) { %>
	<%- acl %> static let collection: MongoKitten.Collection = Meow.database["<%- underscoreCase(uncamel(pluralize(serializable.name))) %>"]

	<%- include('ModelResolvingFunctions', {serializable}); %>
	<% } %>

	<%- include('KeyEnum', {serializable}); %>
	<%- include('Values', {serializable}); %>
	<%- include('VirtualInstanceStructClass', {serializable}); %>
}

<%- include('CustomStringConvertible', {serializable}); %>
