#!/bin/bash

DIRNAME=${PWD##*/}

if [ ! -d ".build" ]; then
	echo "❗️  Meow stores artifacts in the .build directory, but it is not present. Is the working directory a Swift package?"
	echo "Try running 'swift package update'"
	exit 1
fi

if [[ $# == 0 ]]; then
	if [ -f Meowfile ]; then
		echo "🐈  Using Meowfile"
		$0 $(< Meowfile)
		exit
	else
		echo "❗️  Error: no arguments supplied and no Meowfile found"
		echo "See the Meow readme for more information on how to use this script"
		exit 1
	fi
fi

# Swift Package lookup
# Stores relative package URL in PACKAGE_DIR
lookupPackage () {
	local pkgName=$1
	
	if [[ $DIRNAME == "$pkgName" ]]; then
		PACKAGE_DIR="."
	elif [ -d "Packages/Meow" ]; then
		PACKAGE_DIR="Packages/$pkgName"
	else
		PACKAGE_DIR=$(echo ".build/checkouts/$pkgName.git"*)
		
		if [ ! -d $PACKAGE_DIR ]; then
			echo "❗️  Error: package $pkgName was not found"
			exit 1
		fi
	fi
}

lookupPackage Meow
MEOW=$PACKAGE_DIR

echo "🐈  Meow directory: $MEOW"

if [ -f MeowPlugins ]; then
	echo "🐈  Reading plugins file"
	PLUGIN_NUM=0
	while read PLUGIN; do
		lookupPackage "$PLUGIN"
		echo "$PLUGIN found in $PACKAGE_DIR"
		PLUGINS[$PLUGIN_NUM]=$PACKAGE_DIR
		((PLUGIN_NUM=$PLUGIN_NUM+1))
	done < MeowPlugins
else
	echo "ℹ  No plugins file found (./MeowPlugins)"
fi

# Create templates directory
if [ -d ".build/meow-templates" ]; then
	rm -r ".build/meow-templates"
fi

mkdir ".build/meow-templates"

# Copy templates
echo "🐈  Copying templates"
cp -r "$MEOW/Templates/" ".build/meow-templates/"

touch ".build/meow-templates/plugins.ejs"

for p in $PLUGINS; do
	echo "<%- include('../../$p/MeowPlugin.ejs') %>" >> ".build/meow-templates/plugins.ejs"
done

echo "🐈  Running sourcery"

sourcery --templates ".build/meow-templates/Meow.ejs" "$@"

echo "🐈  Done"